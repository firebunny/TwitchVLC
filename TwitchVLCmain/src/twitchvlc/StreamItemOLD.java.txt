package twitchvlc;

import com.google.gson.JsonElement;
import com.google.gson.JsonNull;
import com.google.gson.JsonObject;
import com.google.gson.JsonParser;
import java.awt.Color;
import java.awt.Component;
import java.awt.Dimension;
import java.awt.event.ComponentEvent;
import java.awt.event.ComponentListener;
import java.io.BufferedReader;
import java.io.IOException;
import java.io.InputStreamReader;
import java.net.HttpURLConnection;
import java.net.MalformedURLException;
import java.net.URL;
import java.util.logging.Level;
import java.util.logging.Logger;
import javax.swing.JComponent;
import javax.swing.JLabel;
import javax.swing.JPanel;
import javax.swing.SwingConstants;
import javax.swing.border.Border;

public class StreamItemOLD extends JPanel {
    JLabel imageL;
    JLabel titleL;
    JLabel gameL;
    JLabel nameL;
    JLabel viewL;
    JLabel deleteL;
    JLabel favouriteL;
    JLabel notifyL;
    
    JPanel jpnl;
    
    public static int extraw = 30;
    
    public static int default_width = 466;
    
    private IconHolder IH;
    
    private boolean notify=false;
    public boolean press=false;
    private long lastimagedownload = 0;
    private String username;
    private boolean fav;
    
    private static long lastdel = 0;
    
    private static int offlinew = 466;
    private static int offlineh = 30;
    
    private static int onlinew = 466;
    private static int onlineh = 75;
    
    private static java.awt.Color normal = new java.awt.Color(40, 40, 40);
    private static java.awt.Color highlighted = new java.awt.Color(45, 45, 45);
    private static java.awt.Color selected = new java.awt.Color(30, 30, 30);
    
    private static java.awt.Color redtext = new java.awt.Color(240, 100, 100);
    private static java.awt.Color viewstext = new java.awt.Color(230, 80, 80);
    
    private static java.awt.Color normaltext = new java.awt.Color(150, 150, 150);
    private static java.awt.Color highlighttext = new java.awt.Color(220, 220, 220);
    private static java.awt.Color downtext = new java.awt.Color(220, 220, 220);
    
    
    private static java.awt.Color buttonhighlighted = new java.awt.Color(55, 55, 55);
    
    private static java.awt.Color buttonnormal = new java.awt.Color(50, 50, 50);
    
    private static Border border = javax.swing.BorderFactory.createBevelBorder(0,new java.awt.Color(49,49,49),null,Color.BLACK,null);
    private static Border highlightborder = javax.swing.BorderFactory.createBevelBorder(0,new java.awt.Color(54,54,54),null,Color.BLACK,null);
    private static Border downborder = javax.swing.BorderFactory.createBevelBorder(1,new java.awt.Color(18,18,18),new java.awt.Color(18,18,18),null,Color.BLACK);
    
    public static void setForeground(JComponent com, Color col) {
        if(com==null) {
            return;
        }
        com.setForeground(col);
    }
    
    public static void setDownstate(JComponent com) {
        if(com==null) {
            return;
        }
        com.setBorder(downborder);
        com.setBackground(selected);
        if(com instanceof StreamItemOLD) {
            setForeground(((StreamItemOLD)com).deleteL,downtext);
            setForeground(((StreamItemOLD)com).favouriteL,downtext);
            setForeground(((StreamItemOLD)com).nameL,downtext);
            setForeground(((StreamItemOLD)com).titleL,downtext);
            setForeground(((StreamItemOLD)com).gameL,downtext);
        }
    }
    
    public static void setNormalstate(JComponent com) {
        if(com==null) {
            return;
        }
        com.setBorder(border);
        com.setBackground(normal);
        if(com instanceof StreamItemOLD) {
            setForeground(((StreamItemOLD)com).deleteL,normaltext);
            setForeground(((StreamItemOLD)com).favouriteL,normaltext);
            setForeground(((StreamItemOLD)com).nameL,normaltext);
            setForeground(((StreamItemOLD)com).titleL,normaltext);
            setForeground(((StreamItemOLD)com).gameL,normaltext);
        }
    }
    
    public static void setHighlightstate(JComponent com) {
        if(com==null) {
            return;
        }
        com.setBorder(highlightborder);
        com.setBackground(highlighted);
        if(com instanceof StreamItemOLD) {
            setForeground(((StreamItemOLD)com).deleteL,highlighttext);
            setForeground(((StreamItemOLD)com).favouriteL,highlighttext);
            setForeground(((StreamItemOLD)com).nameL,highlighttext);
            setForeground(((StreamItemOLD)com).titleL,highlighttext);
            setForeground(((StreamItemOLD)com).gameL,highlighttext);
        }
    }
    
    public final String getUserName() {
        return username+"";
    }
    
    public final boolean isFav() {
        return fav;
    }
    
    public StreamItemOLD(final String accName, boolean isFav) {
        super();
        //forceSize(offlinew,offlineh);
        //setWidth(offlinew);
        setFocusable(true);
        this.setBackground(normal);
        username=accName;
        fav=isFav;
        
        //this.setBorder(javax.swing.BorderFactory.createMatteBorder(3, 0, 0, 0, new java.awt.Color(51, 51, 51)));
        
        this.addComponentListener(new ComponentListener() {
            @Override
            public void componentShown(ComponentEvent e) {
                if(getThis().getParent()==null) {
                    return;
                }
                //setBorder(javax.swing.BorderFactory.createMatteBorder(3, 0, 0, 0, getParent().getBackground()));
                setNormalstate(getThis());
            }

            @Override
            public void componentResized(ComponentEvent e) {
                if(getThis().getParent()==null) {
                    return;
                }
                //setBorder(javax.swing.BorderFactory.createMatteBorder(3, 0, 0, 0, getParent().getBackground()));
                setNormalstate(getThis());
            }

            @Override
            public void componentMoved(ComponentEvent e) {
            }

            @Override
            public void componentHidden(ComponentEvent e) {
            }
        });
        
        java.awt.event.MouseAdapter ma = new java.awt.event.MouseAdapter() {
            @Override
            public void mousePressed(java.awt.event.MouseEvent evt) {
                press=true;
                
                setDownstate((StreamItemOLD)evt.getComponent().getParent());
            }
            
            @Override
            public void mouseReleased(java.awt.event.MouseEvent evt) {
                if(!press) {
                    return;
                }
                press=false;
                TwitchVLC.currentName.setToolTipText(getUserName());
                TwitchVLC.currentName.setText(getUserName());
                TwitchVLC.currentTitle.setToolTipText(titleL.getText());
                TwitchVLC.currentTitle.setText(titleL.getText());
                TwitchVLC.currentGame.setToolTipText(gameL.getText());
                TwitchVLC.currentGame.setText(gameL.getText());
                
                setStates(TwitchVLC.mainPanel);
                setStates(TwitchVLC.offPanel);
                setStates(TwitchVLC.searchResultsPanel);
            }
            
            @Override
            public void mouseEntered(java.awt.event.MouseEvent evt) {
                press=false;
                if(!nameL.getText().equals(TwitchVLC.currentName.getText())) {
                    setHighlightstate(getThis());
                }
            }
            
            @Override
            public void mouseExited(java.awt.event.MouseEvent evt) {
                press=false;
                if(nameL.getText().equals(TwitchVLC.currentName.getText())) {
                    setDownstate(getThis());
                }
                else {
                    setNormalstate(getThis());
                }
            }
        };
        //this.addMouseListener(ma);
        
        
        
        //this.setBackground(new java.awt.Color(58, 58, 58));
        //this.setBorder(javax.swing.BorderFactory.createLineBorder(buttonnormal));
        
        this.setLayout(new org.netbeans.lib.awtextra.AbsoluteLayout());
        
        
        imageL = new javax.swing.JLabel();
        //imageL.addMouseListener(ma);
        titleL = new javax.swing.JLabel();
        //titleL.addMouseListener(ma);
        gameL = new javax.swing.JLabel();
        //gameL.addMouseListener(ma);
        nameL = new javax.swing.JLabel();
        //nameL.addMouseListener(ma);
        viewL = new javax.swing.JLabel();
        //viewL.addMouseListener(ma);
        
        
        
        
        notifyL = new javax.swing.JLabel();
        notifyL.addMouseListener(new java.awt.event.MouseAdapter() {
            @Override
            public void mouseClicked(java.awt.event.MouseEvent evt) {
                notify=!notify;
                setNotify(notify);
                TwitchVLC.updateFavouriteFile();
            }
            
            @Override
            public void mouseEntered(java.awt.event.MouseEvent evt) {
                if(!nameL.getText().equals(TwitchVLC.currentName.getText())) {
                    setHighlightstate(getThis());
                }
                
                evt.getComponent().setBackground(buttonhighlighted);
            }
            
            @Override
            public void mouseExited(java.awt.event.MouseEvent evt) {
                if(nameL.getText().equals(TwitchVLC.currentName.getText())) {
                    setDownstate(getThis());
                }
                else {
                    setNormalstate(getThis());
                }
                
                evt.getComponent().setBackground(buttonnormal);
            }
        });
        
        notifyL.setBackground(buttonnormal);
        notifyL.setForeground(normaltext);
        notifyL.setHorizontalAlignment(javax.swing.SwingConstants.CENTER);
        notifyL.setText("notify");
        notifyL.setToolTipText("Notify when stream goes live");
        notifyL.setHorizontalTextPosition(javax.swing.SwingConstants.CENTER);
        notifyL.setOpaque(true);
        this.add(notifyL, new org.netbeans.lib.awtextra.AbsoluteConstraints(170+extraw, 10, 30, 15));
        
        if(isFav()) {
            deleteL = new javax.swing.JLabel();
            deleteL.setBackground(buttonnormal);
            deleteL.setHorizontalAlignment(javax.swing.SwingConstants.CENTER);
            deleteL.setText("delete");
            deleteL.setToolTipText("Delete favourite");
            deleteL.setHorizontalTextPosition(javax.swing.SwingConstants.CENTER);
            deleteL.setOpaque(true);
            this.add(deleteL, new org.netbeans.lib.awtextra.AbsoluteConstraints(205+extraw, 10, 30, 15));
            deleteL.addMouseListener(new java.awt.event.MouseAdapter() {
                @Override
                public void mouseClicked(java.awt.event.MouseEvent evt) {
                    if(lastdel+800>System.currentTimeMillis()) {
                        return;
                    }
                    lastdel=System.currentTimeMillis();
                    getThis().removeAll();
                    imageL=null;
                    titleL=null;
                    gameL=null;
                    nameL=null;
                    viewL=null;
                    deleteL=null;
                    notifyL=null;
                    TwitchVLC.mainPanel.remove(getThis());
                    TwitchVLC.offPanel.remove(getThis());

                    TwitchVLC.mainframe.pack();

                    TwitchVLC.mainPanel.repaint();
                    TwitchVLC.offPanel.repaint();
                    TwitchVLC.updateFavouriteFile();
                }
                
                @Override
                public void mouseEntered(java.awt.event.MouseEvent evt) {
                    if(!nameL.getText().equals(TwitchVLC.currentName.getText())) {
                        setHighlightstate(getThis());
                    }
                    
                    evt.getComponent().setBackground(buttonhighlighted);
                }

                @Override
                public void mouseExited(java.awt.event.MouseEvent evt) {
                    if(nameL.getText().equals(TwitchVLC.currentName.getText())) {
                        setDownstate(getThis());
                    }
                    else {
                        setNormalstate(getThis());
                    }

                    evt.getComponent().setBackground(buttonnormal);
                }
            });
        }
        else {
            favouriteL = new javax.swing.JLabel();
            favouriteL.setBackground(buttonnormal);
            favouriteL.setHorizontalAlignment(javax.swing.SwingConstants.CENTER);
            favouriteL.setText("♥ Add");
            favouriteL.setToolTipText("Add favourite");
            favouriteL.setHorizontalTextPosition(javax.swing.SwingConstants.CENTER);
            favouriteL.setOpaque(true);
            this.add(favouriteL, new org.netbeans.lib.awtextra.AbsoluteConstraints(205+extraw, 10, 30, 15));
            favouriteL.addMouseListener(new java.awt.event.MouseAdapter() {
                @Override
                public void mouseClicked(java.awt.event.MouseEvent evt) {
                    StreamItemOLD si = new StreamItemOLD(getUserName(),true);
                    si.setSize(StreamItemOLD.default_width, 75);
                    TwitchVLC.offPanel.add(si);
                    si.updateStream();
                    TwitchVLC.updateFavouriteFile();
                }
                
                @Override
                public void mouseEntered(java.awt.event.MouseEvent evt) {
                    if(!nameL.getText().equals(TwitchVLC.currentName.getText())) {
                        setHighlightstate(getThis());
                    }

                    evt.getComponent().setBackground(buttonhighlighted);
                }

                @Override
                public void mouseExited(java.awt.event.MouseEvent evt) {
                    if(nameL.getText().equals(TwitchVLC.currentName.getText())) {
                        setDownstate(getThis());
                    }
                    else {
                        setNormalstate(getThis());
                    }

                    evt.getComponent().setBackground(buttonnormal);
                }
            });
        }
        
        
        jpnl = new JPanel();
        jpnl.addMouseListener(ma);
        jpnl.setOpaque(false);
        this.add(jpnl, new org.netbeans.lib.awtextra.AbsoluteConstraints(0, 0, onlinew, onlineh));
        
        
        imageL.setBackground(buttonnormal);
        imageL.setForeground(normaltext);
        //imageL.setOpaque(true);
        imageL.setOpaque(false);
        imageL.setText("No Image");
        imageL.setHorizontalAlignment(0);
        imageL.setVerticalAlignment(SwingConstants.TOP);
        this.add(imageL, new org.netbeans.lib.awtextra.AbsoluteConstraints(290+extraw, 11, 70, 53));
        
        //IH = new IconHolder(this);
        
        titleL.setBackground(buttonnormal);
        titleL.setToolTipText("");
        titleL.setOpaque(true);
        this.add(titleL, new org.netbeans.lib.awtextra.AbsoluteConstraints(10, 50, 270+extraw, 15));

        gameL.setBackground(buttonnormal);
        gameL.setOpaque(true);
        this.add(gameL, new org.netbeans.lib.awtextra.AbsoluteConstraints(10, 30, 270+extraw, 15));

        nameL.setBackground(buttonnormal);
        nameL.setToolTipText(getUserName());
        nameL.setText(getUserName());
        nameL.setOpaque(true);
        this.add(nameL, new org.netbeans.lib.awtextra.AbsoluteConstraints(10, 10, 155+extraw, 15));
        
        viewL.setBackground(buttonnormal);
        viewL.setForeground(viewstext);
        viewL.setHorizontalAlignment(javax.swing.SwingConstants.CENTER);
        viewL.setToolTipText("Live viewers");
        viewL.setHorizontalTextPosition(javax.swing.SwingConstants.CENTER);
        viewL.setOpaque(true);
        this.add(viewL, new org.netbeans.lib.awtextra.AbsoluteConstraints(240+extraw, 10, 40, 15));
    }
    
    public void dothings() {
        jpnl.setMaximumSize(new Dimension(10000,offlineh));
        jpnl.setPreferredSize(new Dimension(10000,offlineh));
        jpnl.setMinimumSize(new Dimension(10000,offlineh));

        jpnl.setBounds(0, 0, offlinew, offlineh);
        jpnl.setBackground(Color.BLACK);
        jpnl.setOpaque(true);
    }
    
    public void setWidth(int newwidth) {
        
        extraw=newwidth-376;
        
        default_width = newwidth;
        offlinew = newwidth;
        onlinew = newwidth;
        
        
        if(this.isOnline()) {
            forceSize(onlinew,onlineh);

            jpnl.setBounds(0, 0, onlinew, onlineh);
        } 
        else {
            forceSize(offlinew,offlineh);

            jpnl.setBounds(0, 0, offlinew, offlineh);
        }
        
        notifyL.setBounds(170+extraw, 10, 30, 15);
        
        notifyL.setText("ZZZZ");
        
        
        if(isFav()) {
            deleteL.setBounds(205+extraw, 10, 30, 15);
        }
        else {
            favouriteL.setBounds(205+extraw, 10, 30, 15);
        }
        
        imageL.setBounds(290+extraw, 11, 70, 53);
        titleL.setBounds(10, 50, 270+extraw, 15);
        gameL.setBounds(10, 30, 270+extraw, 15);
        nameL.setBounds(10, 10, 155+extraw, 15);
        viewL.setBounds(240+extraw, 10, 40, 15);
        
        
    }
    
    public void setStates(JPanel jp) {
        for(Component com: jp.getComponents()) {
            if(com instanceof StreamItemOLD) {
                if(((StreamItemOLD)com).nameL.getText().equalsIgnoreCase(nameL.getText())) {
                    setDownstate(((StreamItemOLD)com));
                }
                else {
                    setNormalstate(((StreamItemOLD)com));
                }
            }
        }
    }
    
    
    @Override
    public String getName() {
        if(nameL==null) {
            return "Offline";
        }
        return nameL.getText();
    }
    
    
    
    public final void forceSize(int w, int h) {
        this.setPreferredSize(new Dimension(w,h));
        this.setMaximumSize(new Dimension(w,h));
        this.setMinimumSize(new Dimension(w,h));
    }
    
    public void clearLabels() {
        titleL.setText("");
        gameL.setText("");
        viewL.setText("");
        //imageL.setIcon(null);
    }
    
    public StreamItemOLD getThis() {
        return this;
    }
    
    public boolean isNotify() {
        return notify;
    }
    
    public void setNotify(boolean noti) {
        notify=noti;
        if(notify) {
            notifyL.setForeground(redtext);
        }
        else {
            notifyL.setForeground(normaltext);
        }
    }
    
    public void moveToOnlineFrame() {
        if(this.getParent() == null) {
            TwitchVLC.mainPanel.add(this);
        }
        else if(this.getParent().equals(TwitchVLC.offPanel)) {
            TwitchVLC.offPanel.remove(this);
            TwitchVLC.mainPanel.add(this);
        }
    }
    
    public void moveToOfflineFrame() {
        if(this.getParent() == null) {
            TwitchVLC.offPanel.add(this);
        }
        else if(this.getParent().equals(TwitchVLC.mainPanel)) {
            TwitchVLC.mainPanel.remove(this);
            TwitchVLC.offPanel.add(this);
        }
    }
    
    public void updateStream() {
        updateStream(false);
    }
    
    public void updateStream(final boolean firsttime) {
        updateStream(firsttime, null);
    }
    
    public void updateStream(final boolean firsttime, final JsonElement streamx) {
        new Thread() {
            @Override
            public void run() {
                JsonElement stream=streamx;
                if(stream==null) {
                    JsonParser jp = new JsonParser();
                    JsonObject jo = (JsonObject)jp.parse(getJSON("https://api.twitch.tv/kraken/streams/"+nameL.getText()));
                    stream = jo.get("stream");
                }
                
                if(stream==null || (stream instanceof JsonNull)) {
                    clearLabels();
                    //forceSize(offlinew,offlineh);
                    setWidth(offlinew);
                    
                    titleL.setText("Offline");
                    titleL.setToolTipText("Offline");
                    moveToOfflineFrame();

                    viewL.setText("Offline");
                    viewL.setToolTipText("Offline");
                    viewL.setForeground(normaltext);
                    //imageL.setIcon(null);
                    IH.setIcon(null);
                    TwitchVLC.sortFavourites();
                    return;
                }
                
                JsonObject channel = (JsonObject)((JsonObject)stream).get("channel");
                String status = channel.get("status").getAsString();
                String game = channel.get("game").getAsString();
                String viewers = ((JsonObject)stream).get("viewers").getAsString();
                String name = channel.get("name").getAsString();
                
                JsonObject preview = (JsonObject)((JsonObject)stream).get("preview");
                String imgurl = preview.get("small").getAsString();

                if((titleL.getText().equals("") || titleL.getText().equals("Offline")) && isNotify() && !firsttime) {
                    // if coming online, announce
                    new Thread() {@Override public void run() {
                        TwitchVLC.voice.speak("User "+nameL.getText().replace("_", " ").trim()+" is online");
                    }}.start();
                    /*
                    final Runnable runnable = (Runnable) Toolkit.getDefaultToolkit().getDesktopProperty("win.sound.exclamation");
                    if (runnable != null) {
                        runnable.run();
                    }*/
                }

                //forceSize(onlinew,onlineh);
                setWidth(onlinew); 

                nameL.setText(name);
                nameL.setToolTipText(name);
                
                gameL.setText(game);
                gameL.setToolTipText(game);

                viewL.setText(viewers);
                viewL.setToolTipText(viewers);
                viewL.setForeground(viewstext);

                titleL.setText(status);
                titleL.setToolTipText(status);
                moveToOnlineFrame();

                try {
                    if(System.currentTimeMillis()-lastimagedownload>60000 || ((titleL.getText().equals("") || titleL.getText().equals("Offline")) && isNotify())) {
                        lastimagedownload=System.currentTimeMillis();

                        IH.setIconToDownload(new URL(imgurl));


                        //BufferedImage img = ImageIO.read(new URL(nList.item(0).getTextContent()));
                        //IH.setIcon(new ImageIcon(img));


                        //imageL.setIcon(new ImageIcon(img));
                    }
                } catch (IOException ex) {
                    Logger.getLogger(TwitchVLC.class.getName()).log(Level.SEVERE, null, ex);
                }
            }
        }.start();
    }

    public static String getJSON(String url) {
        try {
            URL u = new URL(url);
            HttpURLConnection c = (HttpURLConnection) u.openConnection();
            c.setRequestMethod("GET");
            c.setRequestProperty("Content-length", "0");
            c.setUseCaches(false);
            c.setAllowUserInteraction(false);
            //c.setConnectTimeout(timeout);
            //c.setReadTimeout(timeout);
            c.connect();
            int status = c.getResponseCode();

            switch (status) {
                case 200:
                case 201:
                    BufferedReader br = new BufferedReader(new InputStreamReader(c.getInputStream()));
                    StringBuilder sb = new StringBuilder();
                    String line;
                    while ((line = br.readLine()) != null) {
                        sb.append(line+"\n");
                    }
                    br.close();
                    return sb.toString();
            }

        } catch (MalformedURLException ex) {
            //Logger.getLogger(DebugServer.class.getName()).log(Level.SEVERE, null, ex);
            System.out.println(ex.toString());
        } catch (IOException ex) {
            //Logger.getLogger(DebugServer.class.getName()).log(Level.SEVERE, null, ex);
            System.out.println(ex.toString());
        }
        return null;
    }
    
    
    
    public boolean isOnline() {
        if(viewL==null) {
            return false;
        }
        if(viewL.getText().equals("Offline") || viewL.getText().equals("")) {
            return false;
        }
        return true;
    }
    
    public int getViews() {
        if(viewL.getText().equals("") || viewL.getText().equals("Offline")) {
            return -1;
        }
        return Integer.parseInt(viewL.getText());
    }
    
}
